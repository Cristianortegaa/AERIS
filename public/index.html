<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AERIS | Ultimate</title>
    
    <meta property="og:title" content="AERIS Weather">
    <meta property="og:description" content="Previsi√≥n meteorol√≥gica inmersiva.">
    <meta property="og:image" content="/icons/icon-512.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&family=Plus+Jakarta+Sans:wght@500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" type="image/png" href="logo.png">

    <style>
        :root {
            --bg-gradient-1: #bae6fd; --bg-gradient-2: #e0f2fe; --bg-gradient-3: #7dd3fc;
            --glass-bg: rgba(255, 255, 255, 0.65); 
            --glass-border: 1px solid rgba(255,255,255,0.6);
            --text-main: #0c4a6e; --text-sec: #475569; --accent: #0284c7;
            --card-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            --min-temp-color: #3b82f6; --max-temp-color: #ef4444;
            --rain-text: #2563eb;
        }

        [data-theme="dark"] {
            --bg-gradient-1: #0f172a; --bg-gradient-2: #1e293b; --bg-gradient-3: #020617;
            --glass-bg: rgba(15, 23, 42, 0.70); 
            --glass-border: 1px solid rgba(255, 255, 255, 0.08);
            --text-main: #f8fafc; --text-sec: #94a3b8; --accent: #38bdf8;
            --card-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
            --min-temp-color: #60a5fa; --max-temp-color: #f87171;
            --rain-text: #60a5fa;
        }

        [data-theme="rain"] {
            --bg-gradient-1: #334155; --bg-gradient-2: #475569; --bg-gradient-3: #1e293b;
            --glass-bg: rgba(30, 41, 59, 0.75); 
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --text-main: #f1f5f9; --text-sec: #cbd5e1; --accent: #7dd3fc;
            --card-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.4);
            --rain-text: #93c5fd;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            color: var(--text-main); 
            min-height: 100vh; 
            background: linear-gradient(180deg, var(--bg-gradient-1) 0%, var(--bg-gradient-2) 100%);
            transition: background 1.5s ease;
            padding-bottom: 80px; 
            overflow-x: hidden; 
            position: relative;
        }

        /* EFFECTS LAYER */
        #weather-background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; overflow: hidden; }
        .sun-glow { position: absolute; top: -150px; right: -150px; width: 600px; height: 600px; background: radial-gradient(circle, rgba(255,200,50,0.6) 0%, rgba(255,255,255,0) 70%); border-radius: 50%; opacity: 0; transition: opacity 1.5s; animation: sunPulse 8s infinite alternate; }
        [data-weather="sunny"] .sun-glow { opacity: 1; }
        @keyframes sunPulse { 0% {transform: scale(1);} 100% {transform: scale(1.1);} }
        .rain-drop { position: absolute; background: rgba(255,255,255,0.6); width: 2px; height: 20px; top: -50px; animation: fall linear infinite; }
        @keyframes fall { to { transform: translateY(120vh); } }
        .cloud-shape { position: absolute; background: rgba(255,255,255,0.3); border-radius: 50%; filter: blur(30px); opacity: 0; transition: opacity 2s; animation: floatCloud linear infinite; }
        [data-weather="cloudy"] .cloud-shape, [data-theme="rain"] .cloud-shape { opacity: 1; }
        @keyframes floatCloud { from {transform: translateX(-100%);} to {transform: translateX(100vw);} }
        .star { position: absolute; background: white; border-radius: 50%; animation: twinkle ease-in-out infinite; opacity: 0; box-shadow: 0 0 4px rgba(255,255,255,0.8); }
        [data-theme="dark"] .star { opacity: 0.9; }
        [data-theme="rain"] .star { opacity: 0; } 
        @keyframes twinkle { 0%, 100% {opacity: 0.3; transform: scale(0.8);} 50% {opacity: 1; transform: scale(1.2);} }

        /* LAYOUT */
        nav, .container { position: relative; z-index: 10; }
        .container { max-width: 1200px; padding: 0 20px; }
        .bento-grid { display: grid; gap: 16px; grid-template-columns: 1fr; }
        @media (min-width: 768px) { .bento-grid { grid-template-columns: repeat(2, 1fr); } .span-2 { grid-column: span 2; } }
        @media (min-width: 1100px) { .bento-grid { grid-template-columns: repeat(4, 1fr); } .item-main { grid-column: span 2; grid-row: span 2; } .span-full { grid-column: 1 / -1; } }
        
        .glass-card { background: var(--glass-bg); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px); border: var(--glass-border); border-radius: 24px; padding: 20px; box-shadow: var(--card-shadow); transition: transform 0.3s; position: relative; overflow: hidden; }
        
        /* COMPONENTS */
        .temp-big { font-family: 'Outfit'; font-weight: 700; line-height: 1; letter-spacing: -3px; font-size: clamp(4rem, 10vw, 6rem); }
        .display-icon { font-size: clamp(3rem, 6vw, 4.5rem); color: var(--accent); }
        .label-sm { text-transform: uppercase; font-size: 0.7rem; letter-spacing: 1.2px; color: var(--text-sec); font-weight: 800; opacity: 0.8; margin-bottom: 8px; display: block; }
        
        /* Hourly Scroll & Graph */
        .hourly-scroll-wrapper { position: relative; height: 140px; overflow-x: auto; overflow-y: hidden; scrollbar-width: none; -ms-overflow-style: none; }
        .hourly-scroll-wrapper::-webkit-scrollbar { display: none; }
        #hourly-svg { position: absolute; top: 0; left: 0; width: 1000px; height: 100%; pointer-events: none; z-index: 0; }
        .hourly-content { display: flex; gap: 0; position: absolute; top: 0; left: 0; z-index: 1; }
        .hourly-item { width: 60px; display: flex; flex-direction: column; align-items: center; text-align: center; padding-top: 10px; flex-shrink: 0; }
        .hourly-time { font-weight: 700; font-size: 0.85rem; margin-bottom: 5px; opacity: 0.8; }
        .hourly-icon { font-size: 1.4rem; margin-bottom: 30px; color: var(--text-main); } /* Espacio para la linea */
        .hourly-rain { font-size: 0.7rem; color: var(--rain-text); font-weight: 700; position: absolute; top: 60px; }
        .hourly-temp { font-weight: 800; font-size: 1.1rem; margin-top: auto; padding-bottom: 10px; z-index: 2; text-shadow: 0 0 5px var(--glass-bg); }

        /* Sun Widget */
        .sun-widget { position: relative; height: 100px; overflow: hidden; display: flex; justify-content: center; align-items: flex-end; margin-top: 10px; }
        .sun-track { width: 160px; height: 80px; border: 2px dashed rgba(0,0,0,0.2); border-bottom: 0; border-radius: 80px 80px 0 0; position: relative; }
        .sun-orb { width: 16px; height: 16px; background: #fbbf24; border-radius: 50%; position: absolute; bottom: -8px; left: 50%; transform-origin: 50% -72px; box-shadow: 0 0 10px #fbbf24; transition: transform 1s; }
        .sun-horizon { width: 100%; height: 2px; background: rgba(0,0,0,0.1); position: absolute; bottom: 0; }

        /* UV Bar */
        .uv-bar { height: 6px; border-radius: 10px; background: linear-gradient(to right, #4ade80, #facc15, #f87171, #c084fc); position: relative; margin-top: 10px; }
        .uv-dot { width: 10px; height: 10px; background: white; border: 2px solid rgba(0,0,0,0.2); border-radius: 50%; position: absolute; top: -2px; left: 0%; transform: translateX(-50%); transition: left 1s; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        /* Other Widgets */
        .metric-value { font-size: 1.8rem; font-weight: 700; font-family: 'Outfit'; }
        .metric-unit { font-size: 1rem; opacity: 0.6; font-weight: 600; }
        
        .nav-search-group { flex-grow: 1; max-width: 400px; position: relative; }
        .search-input-group { display: flex; align-items: center; background: var(--glass-bg); border-radius: 50px; padding: 5px 15px; border: var(--glass-border); }
        .search-input { border:none; background:transparent; width:100%; outline:none; font-weight:600; color:var(--text-main); }
        .suggestions-list { position: absolute; top: 110%; left: 0; width: 100%; background: var(--glass-bg); backdrop-filter: blur(20px); border-radius: 15px; padding: 0; margin: 0; list-style: none; display: none; z-index: 100; box-shadow: var(--card-shadow); }
        .suggestions-list.show { display: block; }
        .suggestion-item { padding: 10px 15px; border-bottom: 1px solid rgba(0,0,0,0.05); cursor: pointer; }
        .accordion-button { background: transparent !important; box-shadow: none !important; color: var(--text-main) !important; font-weight: 600; }
        .accordion-item { background: transparent; border: none; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .rain-bar-container { height: 6px; background: rgba(0,0,0,0.05); border-radius: 10px; width: 100%; overflow: hidden; margin-top: 5px; }
        .rain-bar-fill { height: 100%; background: var(--rain-text); width: 0%; border-radius: 10px; }

        #loader { position: fixed; inset: 0; z-index: 2000; background: var(--bg-gradient-1); display: flex; justify-content: center; align-items: center; transition: opacity 0.5s; }
        #toast-notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--text-main); color: var(--bg-gradient-1); padding: 12px 24px; border-radius: 50px; font-weight: 600; z-index: 2000; opacity: 0; transition: all 0.4s; }
        #toast-notification.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    </style>
</head>
<body data-theme="light">

    <div id="weather-background">
        <div class="sun-glow"></div>
        <div id="rain-container"></div>
        <div id="cloud-container"></div>
        <div id="star-container"></div>
    </div>

    <div id="loader"><div class="spinner-border text-primary" role="status"></div></div>
    <div id="toast-notification"><i class="bi bi-info-circle-fill"></i><span id="toast-msg"></span></div>

    <nav class="pt-3 mb-3">
        <div class="container navbar-content">
            <div class="fw-bold fs-4" style="font-family:'Outfit'">AERIS</div>
            <div class="nav-search-group">
                <div class="search-input-group">
                    <i class="bi bi-search opacity-50 me-2"></i>
                    <input type="text" class="search-input" id="citySearch" placeholder="Buscar ciudad...">
                    <i class="bi bi-geo-alt-fill opacity-75" style="cursor:pointer" id="geoBtn"></i>
                </div>
                <ul class="suggestions-list" id="suggestions"></ul>
            </div>
            <div>
                <button class="btn btn-sm btn-link text-dark" id="themeBtn"><i class="bi bi-palette-fill fs-5"></i></button>
                <button class="btn btn-sm btn-link text-dark" id="refreshBtn"><i class="bi bi-arrow-clockwise fs-5"></i></button>
            </div>
        </div>
    </nav>

    <div class="container pb-5">
        <div class="bento-grid">
            <div class="glass-card item-main span-2 d-flex flex-column justify-content-between">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <span class="label-sm" style="color: var(--accent); font-size: 0.9rem;" id="city-name-display">...</span>
                        <div class="mt-1 text-capitalize fs-3 fw-bold lh-sm" id="weather-desc">--</div>
                    </div>
                    <i id="main-icon" class="bi bi-sun display-icon filter-shadow"></i>
                </div>
                <div class="mt-3">
                    <div class="d-flex align-items-end">
                        <span class="temp-big" id="display-temp">--</span><span class="fs-1 mb-4 ms-1 opacity-50">¬∞</span>
                    </div>
                    <div class="fw-bold opacity-75 ms-1">Sensaci√≥n: <span id="feels-like">--</span>¬∞</div>
                    <div class="d-flex gap-4 mt-3 fw-bold align-items-center" style="font-size: 1rem;">
                        <span style="color: var(--max-temp-color)"><i class="bi bi-arrow-up-short"></i> <span id="max-temp">--</span>¬∞</span>
                        <span class="opacity-25">|</span>
                        <span style="color: var(--min-temp-color)"><i class="bi bi-arrow-down-short"></i> <span id="min-temp">--</span>¬∞</span>
                    </div>
                </div>
            </div>

            <div class="glass-card span-full py-3" style="padding-bottom: 0;">
                 <div id="hourly-summary" class="small fw-bold opacity-75 mb-3 border-bottom border-secondary border-opacity-10 pb-2">
                    Cargando...
                 </div>
                 <div class="hourly-scroll-wrapper" id="hourly-wrapper">
                    <svg id="hourly-svg" width="1000" height="140">
                        <path id="temp-path" d="" fill="none" stroke="currentColor" stroke-width="3" stroke-opacity="0.3" style="color: var(--accent)"></path>
                    </svg>
                    <div class="hourly-content" id="hourly-container"></div>
                 </div>
            </div>

            <div class="glass-card span-full">
                <span class="label-sm mb-3 d-block">Previsi√≥n 7 D√≠as</span>
                <div class="accordion accordion-flush" id="forecastAccordion"></div>
            </div>

            <div class="glass-card">
                <span class="label-sm"><i class="bi bi-sun"></i> √çndice UV</span>
                <div class="metric-value mt-2"><span id="uv-value">--</span></div>
                <div class="small opacity-75 mb-2" id="uv-text">Moderado</div>
                <div class="uv-bar"><div class="uv-dot" id="uv-dot"></div></div>
            </div>

            <div class="glass-card">
                <span class="label-sm"><i class="bi bi-sunrise"></i> Ciclo Solar</span>
                <div class="sun-widget">
                    <div class="sun-track">
                        <div class="sun-orb" id="sun-orb"></div>
                    </div>
                    <div class="sun-horizon"></div>
                </div>
                <div class="d-flex justify-content-between small fw-bold mt-1 px-2">
                    <span id="sunrise-time">07:30</span>
                    <span id="sunset-time">21:00</span>
                </div>
            </div>

            <div class="glass-card item-uv text-center">
                <span class="label-sm">Viento</span>
                <div class="position-relative my-2 mx-auto" style="width:50px; height:50px;">
                    <i id="wind-arrow" class="bi bi-arrow-up display-4" style="color: var(--accent); transition: transform 0.5s; display:block;"></i>
                </div>
                <div class="fw-bold fs-5"><span id="wind-speed">--</span> km/h</div>
            </div>

            <div class="glass-card text-center d-flex flex-column justify-content-center">
                <span class="label-sm text-start mb-2">Fase Lunar</span>
                <i id="moon-icon" class="bi bi-moon-stars fs-1 mb-2 opacity-75"></i>
                <div class="fw-bold" id="moon-text">Creciente</div>
            </div>

            <div class="glass-card d-flex flex-column justify-content-center">
                <div class="mb-3">
                    <span class="label-sm">Humedad</span>
                    <div class="fw-bold fs-4"><span id="humidity">--</span>%</div>
                </div>
                <div>
                    <span class="label-sm">Presi√≥n</span>
                    <div class="fw-bold fs-5"><span id="pressure">--</span> hPa</div>
                </div>
            </div>

            <div class="glass-card span-2 position-relative" style="padding: 0; height: 350px;">
                <iframe id="radar-frame" width="100%" height="100%" src="" frameborder="0" style="border:none; border-radius: 24px;"></iframe>
                <div style="position:absolute; top:15px; left:15px; background:rgba(0,0,0,0.6); color:white; padding:4px 12px; border-radius:15px; font-size:0.75rem; font-weight:bold; backdrop-filter:blur(5px);">
                    <i class="bi bi-radar"></i> Radar en vivo
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentCity = JSON.parse(localStorage.getItem('savedCity')) || { id: '28065', name: 'Getafe', lat: 40.3, lon: -3.7 };

        // --- PART√çCULAS ---
        const initEffects = () => {
            const rainCont = document.getElementById('rain-container'); rainCont.innerHTML='';
            for(let i=0;i<100;i++){ const d=document.createElement('div');d.className='rain-drop';d.style.left=Math.random()*100+'vw';d.style.animationDuration=(Math.random()*0.8+0.4)+'s';d.style.animationDelay=Math.random()*2+'s';d.style.opacity=0;rainCont.appendChild(d); }
            const cloudCont = document.getElementById('cloud-container'); cloudCont.innerHTML='';
            for(let i=0;i<5;i++){ const c=document.createElement('div');c.className='cloud-shape';c.style.width=(Math.random()*250+150)+'px';c.style.height=(Math.random()*80+50)+'px';c.style.top=(Math.random()*40+5)+'%';c.style.left=-300+'px';c.style.animationDuration=(Math.random()*50+30)+'s';cloudCont.appendChild(c); }
            const starCont = document.getElementById('star-container'); starCont.innerHTML='';
            for(let i=0;i<60;i++){ const s=document.createElement('div');s.className='star';s.style.width=Math.random()*3+'px';s.style.height=s.style.width;s.style.top=Math.random()*70+'%';s.style.left=Math.random()*100+'%';s.style.animationDuration=(Math.random()*3+1)+'s';s.style.animationDelay=Math.random()*2+'s';starCont.appendChild(s); }
        };
        const updateEffectsVisibility = (type) => { document.querySelectorAll('.rain-drop').forEach(d => d.style.opacity = type === 'rain' ? Math.random()*0.4+0.3 : 0); };

        const updateThemeByWeather = (iconCode, rainProb) => {
            const body = document.body;
            const hour = new Date().getHours();
            const isNight = hour >= 21 || hour < 7;
            const iconStr = String(iconCode || "").toLowerCase();
            const isRain = (iconStr.includes('rain') || iconStr.includes('storm') || rainProb >= 50) && !iconStr.includes('sun');

            if (isRain) { body.setAttribute('data-theme', 'rain'); updateEffectsVisibility('rain'); }
            else if (isNight) { body.setAttribute('data-theme', 'dark'); updateEffectsVisibility('none'); }
            else { 
                body.setAttribute('data-theme', 'light'); updateEffectsVisibility('none'); 
                body.setAttribute('data-weather', iconStr.includes('cloud') ? 'cloudy' : 'sunny');
            }
        };

        // --- DIBUJAR CURVA SVG (NIVEL DIOS) ---
        const drawHourlyCurve = (temps) => {
            const svg = document.getElementById('hourly-svg');
            const path = document.getElementById('temp-path');
            if(temps.length < 2) return;

            const itemWidth = 60; 
            const containerHeight = 140;
            const maxTemp = Math.max(...temps) + 2;
            const minTemp = Math.min(...temps) - 2;
            const range = maxTemp - minTemp;

            // Escalar Y: Temperatura a Pixel
            const getY = (t) => {
                const ratio = (t - minTemp) / range; // 0 a 1
                return containerHeight - 30 - (ratio * (containerHeight - 60)); // Margen arriba/abajo
            };

            let d = `M 30 ${getY(temps[0])}`; // Mover al centro del primer item (30px)
            for(let i=1; i<temps.length; i++) {
                const x = 30 + (i * itemWidth);
                const y = getY(temps[i]);
                // Curva de Bezier simple para suavizar
                const prevX = 30 + ((i-1) * itemWidth);
                const prevY = getY(temps[i-1]);
                const cp1x = prevX + (itemWidth / 2);
                const cp1y = prevY;
                const cp2x = x - (itemWidth / 2);
                const cp2y = y;
                d += ` C ${cp1x} ${cp1y}, ${cp2x} ${cp2y}, ${x} ${y}`;
            }
            path.setAttribute('d', d);
            svg.setAttribute('width', Math.max(1000, temps.length * itemWidth));
        };

        // --- L√ìGICA DE FASE LUNAR (Simple) ---
        const getMoonPhase = (date) => {
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            let c = e = j = 0;
            if (month < 3) { year--; month += 12; }
            ++month;
            c = 365.25 * year;
            e = 30.6 * month;
            j = c + e + day - 694039.09;
            j /= 29.53058;
            b = parseInt(j);
            j -= b;
            b = Math.round(j * 8);
            if (b >= 8 ) b = 0;
            const phases = ["Luna Nueva", "Creciente", "Cuarto Creciente", "Gibosa Creciente", "Luna Llena", "Gibosa Menguante", "Cuarto Menguante", "Menguante"];
            const icons = ["bi-circle", "bi-moon", "bi-moon-stars", "bi-moon-fill", "bi-circle-fill", "bi-moon-fill", "bi-moon-stars", "bi-moon"];
            return { text: phases[b], icon: icons[b] };
        };

        // --- RENDER ---
        const renderData = (data) => {
            const daily = data.daily[0];
            const hourly = data.hourly;
            
            // 1. DATA PRINCIPAL
            const current = (hourly && hourly.length > 0) ? hourly[0] : { temp: daily.tempMax, icon: daily.iconoGeneral, desc: daily.descripcionGeneral, rainProb: 0, feelsLike: daily.tempMax, humidity: 50, pressure: 1013 };

            document.getElementById('city-name-display').innerText = currentCity.name.toUpperCase();
            document.getElementById('display-temp').innerText = current.temp;
            document.getElementById('feels-like').innerText = current.feelsLike || current.temp;
            document.getElementById('max-temp').innerText = daily.tempMax;
            document.getElementById('min-temp').innerText = daily.tempMin;
            document.getElementById('weather-desc').innerText = current.desc;
            document.getElementById('main-icon').className = `bi ${current.icon} display-icon filter-shadow`;

            // 2. EXTRAS (Humedad/Presi√≥n)
            document.getElementById('humidity').innerText = current.humidity || 50;
            document.getElementById('pressure').innerText = current.pressure || 1015; // Fallback si no hay dato real

            // 3. HORARIA Y GR√ÅFICA
            const hContainer = document.getElementById('hourly-container');
            const hSummary = document.getElementById('hourly-summary');
            hContainer.innerHTML = '';
            
            if(hourly && hourly.length > 0) {
                const nextRain = hourly.find(h => h.rainProb > 0);
                const nextWind = hourly.find(h => h.windSpeed > 20); // Simulado si no hay dato
                
                // Resumen AI Style
                let summaryText = "Condiciones estables.";
                if(nextRain) summaryText = `‚òî Lluvia (${nextRain.rainProb}%) esperada a las ${nextRain.hour}:00.`;
                else if(current.temp < 5) summaryText = "üß• Hace fr√≠o. Abr√≠gate bien.";
                else if(current.icon.includes('sun')) summaryText = "üòé D√≠a perfecto para salir.";
                
                hSummary.innerText = summaryText;

                const tempsForGraph = [];
                hourly.forEach((h, index) => {
                    tempsForGraph.push(h.temp);
                    const timeLabel = index === 0 ? 'Ahora' : `${h.hour}`;
                    const rainHtml = h.rainProb > 0 ? `<div class="hourly-rain">${h.rainProb}%</div>` : `<div class="hourly-rain"></div>`;
                    
                    const item = document.createElement('div');
                    item.className = 'hourly-item';
                    item.innerHTML = `
                        <div class="hourly-time">${timeLabel}</div>
                        <div class="hourly-icon"><i class="bi ${h.icon}"></i></div>
                        ${rainHtml}
                        <div class="hourly-temp" style="margin-top:${index%2===0?'0':'0'}px">${h.temp}¬∞</div>
                    `;
                    hContainer.appendChild(item);
                });
                drawHourlyCurve(tempsForGraph);
            }

            // 4. UV INDEX (Visual)
            const uv = daily.uv || 0;
            document.getElementById('uv-value').innerText = uv;
            document.getElementById('uv-text').innerText = uv < 3 ? "Bajo" : (uv < 6 ? "Moderado" : "Alto");
            const uvPercent = Math.min((uv / 11) * 100, 100);
            document.getElementById('uv-dot').style.left = `${uvPercent}%`;

            // 5. SOL (Widget Arco)
            const now = new Date();
            const currentMin = now.getHours() * 60 + now.getMinutes();
            // Estimacion simple si no hay dato exacto (Amanecer 7:30 - Puesta 21:00)
            const sunriseMin = 7 * 60 + 30; 
            const sunsetMin = 21 * 60;
            
            let sunPercent = 0;
            if(currentMin > sunriseMin && currentMin < sunsetMin) {
                const dayLength = sunsetMin - sunriseMin;
                sunPercent = ((currentMin - sunriseMin) / dayLength) * 100;
            } else if (currentMin >= sunsetMin) {
                sunPercent = 100;
            }
            // Rotar el sol: -90deg (amanecer) a 90deg (puesta)
            const rot = -72 + (sunPercent / 100 * 144); // Ajustado al arco visible CSS
            document.getElementById('sun-orb').style.transform = `rotate(${rot}deg)`;

            // 6. LUNA
            const phase = getMoonPhase(now);
            document.getElementById('moon-text').innerText = phase.text;
            document.getElementById('moon-icon').className = `bi ${phase.icon} fs-1 mb-2 opacity-75`;

            // 7. SEMANAL (Barras de Lluvia)
            const accordion = document.getElementById('forecastAccordion');
            accordion.innerHTML = '';
            data.daily.slice(1).forEach((day, index) => {
                const dateStr = new Date(day.fecha).toLocaleDateString('es-ES', {weekday:'long', day:'numeric'});
                const mRain = Math.max(...day.periodos.map(p => p.probLluvia));
                const rainWidth = mRain + '%';
                const rainColor = mRain > 0 ? 'var(--rain-text)' : 'transparent';
                
                accordion.innerHTML += `
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#c${index}">
                            <div class="d-flex align-items-center w-100 pe-2">
                                <div style="width:35%" class="text-capitalize small text-start">${dateStr.split(',')[0]}</div>
                                <div style="width:25%; display:flex; flex-direction:column; justify-content:center; padding:0 10px;">
                                    <div style="font-size:0.6rem; opacity:0.7; text-align:center; margin-bottom:2px">${mRain > 0 ? mRain+'%' : ''}</div>
                                    <div class="rain-bar-container"><div class="rain-bar-fill" style="width:${rainWidth}; background:${rainColor}"></div></div>
                                </div>
                                <i class="bi ${day.iconoGeneral} fs-5 mx-auto text-primary" style="width:10%"></i>
                                <div class="text-end fw-bold" style="width:30%">
                                    <span class="small" style="color:var(--max-temp-color)">${day.tempMax}¬∞</span> 
                                    <span class="text-secondary opacity-50 small">/</span> 
                                    <span class="small" style="color:var(--min-temp-color)">${day.tempMin}¬∞</span>
                                </div>
                            </div>
                        </button>
                    </h2>
                    <div id="c${index}" class="accordion-collapse collapse" data-bs-parent="#forecastAccordion">
                        <div class="accordion-body pt-0 text-center small opacity-75">
                            ${day.descripcionGeneral}
                        </div>
                    </div>
                </div>`;
            });

            // 8. TEMA
            const currentRainProb = (hourly && hourly.length > 0) ? hourly[0].rainProb : 0;
            updateThemeByWeather(current.icon, currentRainProb);

            // 9. RADAR
            if(currentCity.lat) document.getElementById('radar-frame').src = `https://embed.windy.com/embed2.html?lat=${currentCity.lat}&lon=${currentCity.lon}&detailLat=${currentCity.lat}&detailLon=${currentCity.lon}&width=650&height=450&zoom=8&level=surface&overlay=rain&product=ecmwf&menu=&message=&marker=&calendar=now&pressure=&type=map&location=coordinates&detail=&metricWind=km%2Fh&metricTemp=%C2%B0C&radarRange=-1`;
        };

        initEffects();
        async function fetchWeather(cityId) {
            const loader = document.getElementById('loader'); loader.style.opacity = '1';
            try {
                const res = await fetch(`/api/weather/${cityId}`);
                if(!res.ok) throw new Error("API Error");
                const data = await res.json();
                renderData(data);
            } catch(e) { console.error(e); }
            finally { setTimeout(() => { loader.style.opacity = '0'; setTimeout(()=>loader.style.display='none',500); }, 500); }
        }

        // Buscador
        const searchInput = document.getElementById('citySearch');
        const suggestionsList = document.getElementById('suggestions');
        let searchTimeout;
        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            if (e.target.value.length < 2) return suggestionsList.classList.remove('show');
            searchTimeout = setTimeout(async () => {
                const res = await fetch(`/api/search/${e.target.value}`);
                const cities = await res.json();
                suggestionsList.innerHTML = cities.map(c => `<li class="suggestion-item" onclick='selectCity(${JSON.stringify(c)})'>${c.name}</li>`).join('');
                if(cities.length) suggestionsList.classList.add('show');
            }, 300);
        });
        const selectCity = (city) => {
            currentCity = city; localStorage.setItem('savedCity', JSON.stringify(city));
            suggestionsList.classList.remove('show'); document.getElementById('citySearch').value='';
            fetchWeather(city.id);
        };
        document.getElementById('geoBtn').addEventListener('click', () => {
             if(!navigator.geolocation) return;
             navigator.geolocation.getCurrentPosition(async (pos) => {
                 const res = await fetch(`/api/geo?lat=${pos.coords.latitude}&lon=${pos.coords.longitude}`);
                 const city = await res.json();
                 if(city.name) selectCity(city);
             });
        });
        document.getElementById('refreshBtn').addEventListener('click', () => fetchWeather(currentCity.id));
        document.getElementById('themeBtn').addEventListener('click', () => {
             const current = document.body.getAttribute('data-theme');
             const next = current === 'dark' ? 'light' : 'dark';
             document.body.setAttribute('data-theme', next);
        });

        fetchWeather(currentCity.id);
    </script>
</body>
</html>