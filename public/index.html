<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AERIS | Weather Experience</title>
    
    <meta property="og:title" content="AERIS Weather">
    <meta property="og:description" content="PrevisiÃ³n meteorolÃ³gica inmersiva.">
    <meta property="og:image" content="/icons/icon-512.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Plus+Jakarta+Sans:wght@500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" type="image/png" href="logo.png">

    <style>
        :root {
            --bg-gradient-1: #bae6fd; --bg-gradient-2: #e0f2fe; --bg-gradient-3: #7dd3fc;
            --glass-bg: rgba(255, 255, 255, 0.60); 
            --glass-border: 2px solid rgba(255,255,255,0.5);
            --text-main: #0c4a6e; --text-sec: #475569; --accent: #0284c7;
            --card-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            --min-temp-color: #3b82f6; --max-temp-color: #ef4444;
            --rain-text: #2563eb;
        }

        /* --- TEMA NOCHE --- */
        [data-theme="dark"] {
            --bg-gradient-1: #0f172a; --bg-gradient-2: #1e293b; --bg-gradient-3: #020617;
            --glass-bg: rgba(15, 23, 42, 0.70); 
            --glass-border: 1px solid rgba(255, 255, 255, 0.08);
            --text-main: #f8fafc; --text-sec: #94a3b8; --accent: #38bdf8;
            --card-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
            --min-temp-color: #60a5fa; --max-temp-color: #f87171;
            --rain-text: #60a5fa;
        }

        /* --- TEMA LLUVIA --- */
        [data-theme="rain"] {
            --bg-gradient-1: #334155; --bg-gradient-2: #475569; --bg-gradient-3: #1e293b;
            --glass-bg: rgba(30, 41, 59, 0.75); 
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --text-main: #f1f5f9; --text-sec: #cbd5e1; --accent: #7dd3fc;
            --card-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.4);
            --rain-text: #93c5fd;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            color: var(--text-main); 
            min-height: 100vh; 
            background: linear-gradient(180deg, var(--bg-gradient-1) 0%, var(--bg-gradient-2) 100%);
            transition: background 1.5s ease;
            padding-bottom: 80px; 
            overflow-x: hidden; 
            position: relative;
        }

        /* CAPA DE EFECTOS (Fondo Fijo) */
        #weather-background { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 0; /* DetrÃ¡s del contenido */
            pointer-events: none; overflow: hidden; 
        }

        /* Contenido debe estar por encima del fondo */
        nav, .container { position: relative; z-index: 10; }

        /* --- EFECTO SOL --- */
        .sun-glow { 
            position: absolute; top: -150px; right: -150px; width: 600px; height: 600px; 
            background: radial-gradient(circle, rgba(255,200,50,0.6) 0%, rgba(255,255,255,0) 70%); 
            border-radius: 50%; opacity: 0; transition: opacity 1.5s; 
            animation: sunPulse 8s infinite alternate; 
        }
        [data-weather="sunny"] .sun-glow { opacity: 1; }
        @keyframes sunPulse { 0% {transform: scale(1);} 100% {transform: scale(1.1);} }

        /* --- EFECTO LLUVIA --- */
        .rain-drop { 
            position: absolute; background: rgba(255,255,255,0.6); 
            width: 2px; height: 20px; top: -50px; 
            animation: fall linear infinite; 
        }
        @keyframes fall { to { transform: translateY(120vh); } }

        /* --- EFECTO NUBES --- */
        .cloud-shape { 
            position: absolute; background: rgba(255,255,255,0.3); 
            border-radius: 50%; filter: blur(30px); 
            opacity: 0; transition: opacity 2s; 
            animation: floatCloud linear infinite;
        }
        [data-weather="cloudy"] .cloud-shape, [data-theme="rain"] .cloud-shape { opacity: 1; }
        @keyframes floatCloud { from {transform: translateX(-100%);} to {transform: translateX(100vw);} }

        /* --- EFECTO ESTRELLAS --- */
        .star { 
            position: absolute; background: white; border-radius: 50%; 
            animation: twinkle ease-in-out infinite; opacity: 0; 
            box-shadow: 0 0 4px rgba(255,255,255,0.8);
        }
        [data-theme="dark"] .star { opacity: 0.9; }
        /* Si llueve de noche, ocultar estrellas para que se vea la lluvia mejor */
        [data-theme="rain"] .star { opacity: 0; } 
        @keyframes twinkle { 0%, 100% {opacity: 0.3; transform: scale(0.8);} 50% {opacity: 1; transform: scale(1.2);} }

        /* Estilos UI Generales */
        .container { max-width: 1200px; padding: 0 20px; }
        .bento-grid { display: grid; gap: 16px; grid-template-columns: 1fr; }
        @media (min-width: 768px) { .bento-grid { grid-template-columns: repeat(2, 1fr); } .span-2 { grid-column: span 2; } }
        @media (min-width: 1100px) { .bento-grid { grid-template-columns: repeat(4, 1fr); } .item-main { grid-column: span 2; grid-row: span 2; } .item-chart { grid-column: span 2; grid-row: span 1; } .span-full { grid-column: 1 / -1; } }
        
        .glass-card { background: var(--glass-bg); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border: var(--glass-border); border-radius: 28px; padding: 24px; box-shadow: var(--card-shadow); transition: transform 0.3s; position: relative; overflow: hidden; }
        
        .navbar-content { display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap; }
        .search-input-group { display: flex; align-items: center; background: var(--glass-bg); border: var(--glass-border); border-radius: 50px; padding: 5px 10px 5px 20px; box-shadow: var(--card-shadow); backdrop-filter: blur(12px); }
        .search-input { border: none; background: transparent; outline: none; width: 100%; color: var(--text-main); font-weight: 600; font-family: 'Outfit'; }
        .geo-btn { background: var(--accent); color: white; border: none; border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-left: 10px; }
        .suggestions-list { position: absolute; top: 115%; left: 0; right: 0; background: var(--glass-bg); backdrop-filter: blur(20px); border-radius: 20px; border: var(--glass-border); box-shadow: var(--card-shadow); max-height: 250px; overflow-y: auto; opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all 0.2s; list-style: none; padding: 0; margin: 0; z-index: 2000; }
        .suggestions-list.show { opacity: 1; visibility: visible; transform: translateY(0); }
        .suggestion-item { padding: 12px 20px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.1); font-weight: 600; }
        .suggestion-item:hover { background: var(--accent); color: white; }

        .temp-big { font-family: 'Outfit'; font-weight: 700; line-height: 1; letter-spacing: -2px; font-size: clamp(3.5rem, 8vw, 5rem); }
        .display-icon { font-size: clamp(3rem, 6vw, 4.5rem); color: var(--accent); }
        .label-sm { text-transform: uppercase; font-size: 0.75rem; letter-spacing: 1.5px; color: var(--text-sec); font-weight: 800; }
        .icon-btn { width: 45px; height: 45px; border-radius: 50%; border: var(--glass-border); background: var(--glass-bg); color: var(--text-main); display: flex; justify-content: center; align-items: center; cursor: pointer; font-size: 1.2rem; box-shadow: var(--card-shadow); transition: all 0.2s; }
        .hourly-scroll { display: flex; overflow-x: auto; gap: 20px; padding: 10px 5px; scrollbar-width: none; mask-image: linear-gradient(to right, transparent, black 10px, black 95%, transparent); -webkit-mask-image: linear-gradient(to right, transparent, black 10px, black 95%, transparent); }
        .hourly-scroll::-webkit-scrollbar { display: none; }
        .hourly-item { display: flex; flex-direction: column; align-items: center; min-width: 55px; text-align: center; }
        .hourly-time { font-weight: 700; font-size: 0.9rem; margin-bottom: 8px; opacity: 0.9; }
        .hourly-icon { font-size: 1.5rem; margin-bottom: 5px; color: var(--text-main); }
        .hourly-rain { font-size: 0.75rem; color: var(--rain-text); font-weight: 700; min-height: 1.2em; }
        .hourly-temp { font-weight: 700; font-size: 1.1rem; }
        .accordion-button { background: transparent !important; color: var(--text-main) !important; box-shadow: none !important; }
        .accordion-item { border: none; background: transparent; border-bottom: 1px solid rgba(255,255,255,0.2); }
        
        #loader { position: fixed; inset: 0; z-index: 2000; background: var(--bg-gradient-1); display: flex; justify-content: center; align-items: center; transition: opacity 0.5s; }
        #toast-notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--text-main); color: var(--bg-gradient-1); padding: 12px 24px; border-radius: 50px; font-weight: 600; z-index: 2000; opacity: 0; transition: all 0.4s; }
        #toast-notification.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    </style>
</head>
<body data-theme="light">

    <div id="weather-background">
        <div class="sun-glow"></div>
        <div id="rain-container"></div>
        <div id="cloud-container"></div>
        <div id="star-container"></div>
    </div>

    <div id="loader"><div class="spinner-border text-primary" role="status"></div></div>
    <div id="toast-notification"><i class="bi bi-info-circle-fill"></i><span id="toast-msg">Mensaje</span></div>

    <nav class="pt-3 mb-3">
        <div class="container navbar-content">
            <div class="nav-title-group"><span style="font-family: 'Outfit'; font-weight: 800; font-size: 1.5rem; letter-spacing: -1px;">AERIS</span></div>
            <div class="nav-search-group">
                <div class="search-input-group">
                    <i class="bi bi-search text-secondary me-2"></i>
                    <input type="text" class="search-input" id="citySearch" placeholder="Buscar municipio..." autocomplete="off">
                    <button class="geo-btn" id="geoBtn"><i class="bi bi-geo-alt-fill"></i></button>
                </div>
                <ul class="suggestions-list" id="suggestions"></ul>
            </div>
            <div class="nav-buttons-group">
                <button class="icon-btn" id="themeBtn"><i class="bi bi-palette-fill"></i></button>
                <button class="icon-btn" id="refreshBtn"><i class="bi bi-arrow-clockwise"></i></button>
            </div>
        </div>
    </nav>

    <div class="container pb-5">
        <div class="bento-grid">
            <div class="glass-card item-main span-2 d-flex flex-column justify-content-between">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <span class="label-sm" style="color: var(--accent)" id="city-name-display">...</span>
                        <div class="mt-2 text-capitalize fs-4 fw-bold lh-sm" id="weather-desc">--</div>
                    </div>
                    <i id="main-icon" class="bi bi-sun display-icon filter-shadow"></i>
                </div>
                <div class="mt-4">
                    <div class="d-flex align-items-end">
                        <span class="temp-big" id="display-temp">--</span><span class="fs-1 mb-3 ms-1 opacity-50">Â°</span>
                    </div>
                    <div class="d-flex gap-4 mt-2 fw-bold align-items-center" style="font-size: 1rem;">
                        <span class="d-flex align-items-center" style="color: var(--min-temp-color)"><i class="bi bi-arrow-down-short fs-4"></i> <span id="min-temp">--</span>Â°</span>
                        <span class="text-secondary opacity-25">|</span>
                        <span class="d-flex align-items-center" style="color: var(--max-temp-color)"><i class="bi bi-arrow-up-short fs-4"></i> <span id="max-temp">--</span>Â°</span>
                    </div>
                </div>
            </div>

            <div class="glass-card span-full py-3">
                 <div id="hourly-summary" class="small opacity-75 mb-3 border-bottom border-secondary border-opacity-25 pb-2">
                    Cargando...
                 </div>
                 <div class="hourly-scroll" id="hourly-container"></div>
            </div>

            <div class="glass-card span-full">
                <span class="label-sm mb-3 d-block">PrevisiÃ³n Semanal</span>
                <div class="accordion accordion-glass" id="forecastAccordion"></div>
            </div>

            <div class="glass-card span-2 position-relative" style="padding: 0; height: 300px;">
                <iframe id="radar-frame" width="100%" height="100%" src="" frameborder="0" style="border:none; border-radius: 28px;"></iframe>
                <div style="position:absolute; top:10px; left:15px; background:rgba(0,0,0,0.5); color:white; padding:2px 8px; border-radius:10px; font-size:0.7rem;">Radar Tiempo Real</div>
            </div>

            <div class="glass-card item-uv text-center">
                <span class="label-sm">Viento</span>
                <div class="position-relative my-3 mx-auto" style="width:50px; height:50px;">
                    <i id="wind-arrow" class="bi bi-arrow-up display-4" style="color: var(--accent); transition: transform 0.5s; display:block;"></i>
                </div>
                <div class="fw-bold fs-5"><span id="wind-speed">--</span> km/h</div>
            </div>

            <div class="glass-card text-center d-flex flex-column justify-content-center">
                <span class="label-sm mb-2">Lluvia Hoy</span>
                <div class="progress bg-secondary bg-opacity-10 mb-2" style="height: 10px; border-radius: 10px;">
                    <div id="rain-bar" class="progress-bar bg-primary" role="progressbar" style="width: 0%; border-radius: 10px;"></div>
                </div>
                <div class="fw-bold fs-5"><span id="rain-prob">0</span>%</div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentCity = JSON.parse(localStorage.getItem('savedCity')) || { id: '28065', name: 'Getafe', lat: 40.3, lon: -3.7 };

        // --- INICIALIZAR EFECTOS (GENERAR DIVS) ---
        const initEffects = () => {
            // Lluvia
            const rainCont = document.getElementById('rain-container');
            rainCont.innerHTML = '';
            for(let i=0; i<100; i++) {
                const drop = document.createElement('div');
                drop.className = 'rain-drop';
                drop.style.left = Math.random() * 100 + 'vw';
                drop.style.animationDuration = (Math.random() * 0.8 + 0.4) + 's'; // MÃ¡s rÃ¡pida
                drop.style.animationDelay = Math.random() * 2 + 's';
                drop.style.opacity = 0; // Se controla luego
                rainCont.appendChild(drop);
            }
            // Nubes
            const cloudCont = document.getElementById('cloud-container');
            cloudCont.innerHTML = '';
            for(let i=0; i<5; i++) {
                const cloud = document.createElement('div');
                cloud.className = 'cloud-shape';
                cloud.style.width = (Math.random() * 250 + 150) + 'px';
                cloud.style.height = (Math.random() * 80 + 50) + 'px';
                cloud.style.top = (Math.random() * 40 + 5) + '%';
                cloud.style.left = -300 + 'px';
                cloud.style.animationDuration = (Math.random() * 50 + 30) + 's';
                cloudCont.appendChild(cloud);
            }
            // Estrellas
            const starCont = document.getElementById('star-container');
            starCont.innerHTML = '';
            for(let i=0; i<60; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.width = Math.random() * 3 + 'px';
                star.style.height = star.style.width;
                star.style.top = Math.random() * 70 + '%';
                star.style.left = Math.random() * 100 + '%';
                star.style.animationDuration = (Math.random() * 3 + 1) + 's';
                star.style.animationDelay = Math.random() * 2 + 's';
                starCont.appendChild(star);
            }
        };

        const updateRainVisibility = (isRain) => {
            const drops = document.querySelectorAll('.rain-drop');
            drops.forEach(d => {
                // Si llueve, opacidad aleatoria para efecto natural. Si no, 0.
                d.style.opacity = isRain ? Math.random() * 0.4 + 0.3 : 0; 
            });
        };

        // --- ðŸ”¥ LÃ“GICA DE TEMA ROBUSTA ðŸ”¥ ---
        const updateThemeByWeather = (iconCode, rainProb) => {
            const body = document.body;
            const hour = new Date().getHours();
            const isNight = hour >= 21 || hour < 7;
            
            // Normalizar cÃ³digo icono (asegurar que es string)
            const iconStr = String(iconCode || "").toLowerCase();

            // 1. DETECCIÃ“N DE LLUVIA (Prioridad absoluta)
            // Si el icono dice lluvia/tormenta O la probabilidad es > 40% (y no es solo "nublado")
            const isRainIcon = iconStr.includes('rain') || iconStr.includes('drizzle') || iconStr.includes('storm') || iconStr.includes('lightning') || iconStr.includes('snow');
            const isRainProb = rainProb >= 40 && !iconStr.includes('sun') && !iconStr.includes('clear'); // Evita lluvia con sol radiante

            if (isRainIcon || isRainProb) {
                console.log("Modo: LLUVIA ðŸŒ§ï¸");
                body.setAttribute('data-theme', 'rain');
                body.setAttribute('data-weather', 'rainy');
                updateRainVisibility(true); // Activar gotas
            } 
            // 2. DETECCIÃ“N DE NOCHE (Si no llueve)
            else if (isNight) {
                console.log("Modo: NOCHE ðŸŒ™");
                body.setAttribute('data-theme', 'dark');
                body.setAttribute('data-weather', 'clear-night'); // Esto activa estrellas
                updateRainVisibility(false);
            } 
            // 3. DETECCIÃ“N DE DÃA (Nubes vs Sol)
            else {
                body.setAttribute('data-theme', 'light');
                updateRainVisibility(false);
                
                if (iconStr.includes('cloud') || iconStr.includes('fog') || iconStr.includes('mist')) {
                    console.log("Modo: DÃA NUBLADO â˜ï¸");
                    body.setAttribute('data-weather', 'cloudy'); // Activa nubes
                } else {
                    console.log("Modo: DÃA SOLEADO â˜€ï¸");
                    body.setAttribute('data-weather', 'sunny'); // Activa sol
                }
            }
        };

        const renderData = (data) => {
            const daily = data.daily[0];
            const hourly = data.hourly;
            
            // Datos actuales (Sincronizados)
            const current = (hourly && hourly.length > 0) ? hourly[0] : { 
                temp: daily.tempMax, icon: daily.iconoGeneral, desc: daily.descripcionGeneral, rainProb: 0 
            };

            // Rellenar UI Principal
            document.getElementById('city-name-display').innerText = currentCity.name.toUpperCase();
            document.getElementById('display-temp').innerText = current.temp;
            document.getElementById('max-temp').innerText = daily.tempMax;
            document.getElementById('min-temp').innerText = daily.tempMin;
            document.getElementById('weather-desc').innerText = current.desc;
            document.getElementById('main-icon').className = `bi ${current.icon} display-icon filter-shadow`;

            // Actualizar Tema (Usando datos de AHORA MISMO)
            updateThemeByWeather(current.icon, current.rainProb);

            // Carrusel Horario
            const hContainer = document.getElementById('hourly-container');
            const hSummary = document.getElementById('hourly-summary');
            hContainer.innerHTML = '';
            
            if(hourly && hourly.length > 0) {
                const nextRain = hourly.find(h => h.rainProb > 0);
                hSummary.innerText = nextRain 
                    ? `Probabilidad de lluvia (${nextRain.rainProb}%) a las ${nextRain.hour}:00.`
                    : "Cielos despejados las prÃ³ximas 24h.";

                hourly.forEach((h, index) => {
                    const timeLabel = index === 0 ? 'Ahora' : `${h.hour}`;
                    const rainHtml = h.rainProb > 0 ? `<div class="hourly-rain">${h.rainProb}%</div>` : `<div class="hourly-rain"></div>`;
                    
                    const item = document.createElement('div');
                    item.className = 'hourly-item';
                    item.innerHTML = `
                        <div class="hourly-time">${timeLabel}</div>
                        <div class="hourly-icon"><i class="bi ${h.icon}"></i></div>
                        ${rainHtml}
                        <div class="hourly-temp">${h.temp}Â°</div>
                    `;
                    hContainer.appendChild(item);
                });
            } else {
                hSummary.innerText = "Datos horarios no disponibles.";
            }

            // Radar, Viento y GrÃ¡ficos
            if(currentCity.lat) {
                document.getElementById('radar-frame').src = `https://embed.windy.com/embed2.html?lat=${currentCity.lat}&lon=${currentCity.lon}&detailLat=${currentCity.lat}&detailLon=${currentCity.lon}&width=650&height=450&zoom=8&level=surface&overlay=rain&product=ecmwf&menu=&message=&marker=&calendar=now&pressure=&type=map&location=coordinates&detail=&metricWind=km%2Fh&metricTemp=%C2%B0C&radarRange=-1`;
            }
            const currentPeriod = daily.periodos.find(p => p.horario === '12-18') || daily.periodos[0];
            document.getElementById('wind-speed').innerText = currentPeriod ? currentPeriod.vientoVel : '--';
            if(currentPeriod) document.getElementById('wind-arrow').style.transform = `rotate(${currentPeriod.vientoRot || 0}deg)`;
            
            const maxRainDaily = Math.max(...daily.periodos.map(p => p.probLluvia));
            document.getElementById('rain-prob').innerText = maxRainDaily;
            document.getElementById('rain-bar').style.width = `${maxRainDaily}%`;

            // AcordeÃ³n Semanal
            const accordion = document.getElementById('forecastAccordion');
            accordion.innerHTML = '';
            data.daily.slice(1).forEach((day, index) => {
                const dateStr = new Date(day.fecha).toLocaleDateString('es-ES', {weekday:'long', day:'numeric'});
                const mRain = Math.max(...day.periodos.map(p => p.probLluvia));
                accordion.innerHTML += `
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#c${index}">
                            <div class="d-flex align-items-center w-100 pe-2">
                                <div style="width:40%" class="text-capitalize small text-start">${dateStr.split(',')[0]}</div>
                                <i class="bi ${day.iconoGeneral} fs-5 mx-auto text-primary"></i>
                                <div class="text-end fw-bold" style="width:40%">
                                    <span class="small" style="color:var(--max-temp-color)">${day.tempMax}Â°</span> 
                                    <span class="text-secondary opacity-50 small">/</span> 
                                    <span class="small" style="color:var(--min-temp-color)">${day.tempMin}Â°</span>
                                </div>
                            </div>
                        </button>
                    </h2>
                    <div id="c${index}" class="accordion-collapse collapse" data-bs-parent="#forecastAccordion">
                        <div class="accordion-body pt-0 text-center small opacity-75">
                            ${day.descripcionGeneral}. Lluvia: ${mRain}%
                        </div>
                    </div>
                </div>`;
            });
        };

        // --- INICIO ---
        initEffects(); // Crea las partÃ­culas al cargar
        
        async function fetchWeather(cityId) {
            const loader = document.getElementById('loader');
            loader.style.opacity = '1';
            try {
                const res = await fetch(`/api/weather/${cityId}`);
                if(!res.ok) throw new Error("API Error");
                const data = await res.json();
                renderData(data);
            } catch(e) { console.error(e); }
            finally { setTimeout(() => { loader.style.opacity = '0'; setTimeout(()=>loader.style.display='none',500); }, 500); }
        }

        // Buscador
        const searchInput = document.getElementById('citySearch');
        const suggestionsList = document.getElementById('suggestions');
        let searchTimeout;
        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            if (e.target.value.length < 2) return suggestionsList.classList.remove('show');
            searchTimeout = setTimeout(async () => {
                const res = await fetch(`/api/search/${e.target.value}`);
                const cities = await res.json();
                suggestionsList.innerHTML = cities.map(c => `<li class="suggestion-item" onclick='selectCity(${JSON.stringify(c)})'>${c.name}</li>`).join('');
                if(cities.length) suggestionsList.classList.add('show');
            }, 300);
        });
        const selectCity = (city) => {
            currentCity = city; localStorage.setItem('savedCity', JSON.stringify(city));
            suggestionsList.classList.remove('show'); document.getElementById('citySearch').value='';
            fetchWeather(city.id);
        };
        document.getElementById('geoBtn').addEventListener('click', () => {
             if(!navigator.geolocation) return;
             navigator.geolocation.getCurrentPosition(async (pos) => {
                 const res = await fetch(`/api/geo?lat=${pos.coords.latitude}&lon=${pos.coords.longitude}`);
                 const city = await res.json();
                 if(city.name) selectCity(city);
             });
        });
        document.getElementById('refreshBtn').addEventListener('click', () => fetchWeather(currentCity.id));
        document.getElementById('themeBtn').addEventListener('click', () => {
             // Toggle manual simple para testear
             const current = document.body.getAttribute('data-theme');
             const next = current === 'dark' ? 'light' : 'dark';
             document.body.setAttribute('data-theme', next);
        });

        fetchWeather(currentCity.id);
    </script>
</body>
</html>